rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ============================================
    // STUDENTS COLLECTION
    // ============================================
    match /students/{studentId} {
      // Allow read if user is authenticated
      // Note: School filtering is done in the app code using schoolCode
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated (teacher creating student)
      allow create: if isAuthenticated() && 
                        request.resource.data.keys().hasAll(['name', 'email', 'schoolCode']);
      
      // Allow update if user is authenticated
      // schoolCode cannot be changed
      allow update: if isAuthenticated() && 
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['schoolCode']));
      
      // Allow delete if user is authenticated (teacher)
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // TEACHERS COLLECTION
    // ============================================
    match /teachers/{teacherId} {
      // Allow read if user is authenticated
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated and creating their own document
      allow create: if isAuthenticated() && 
                       request.auth.uid == teacherId &&
                       request.resource.data.keys().hasAll(['email', 'schoolCode']);
      
      // Allow update if user is updating their own document
      // schoolCode cannot be changed
      allow update: if isAuthenticated() && 
                       request.auth.uid == teacherId &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['schoolCode']));
      
      // Teachers cannot delete their own documents
      allow delete: if false;
    }
    
    // ============================================
    // ATTENDANCE_RECORDS COLLECTION
    // ============================================
    match /attendance_records/{recordId} {
      // Allow read if user is authenticated
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated (teacher marking attendance)
      // Required fields: studentName, className, date, status, schoolCode
      // Optional fields: studentId, rollNumber, createdAt
      allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['studentName', 'className', 'date', 'status', 'schoolCode']);
      
      // Attendance records should not be updated (as per requirement - never overwrite old records)
      allow update: if false;
      
      // Allow delete if user is authenticated (teacher)
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // ATTENDANCE_SESSIONS COLLECTION
    // ============================================
    match /attendance_sessions/{sessionId} {
      // Allow read if user is authenticated
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated (teacher creating attendance session)
      // Required fields: className, date, totalStudents, presentCount, absentCount, schoolCode
      // Optional fields: createdAt, updatedAt
      allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['className', 'date', 'totalStudents', 'presentCount', 'absentCount', 'schoolCode']);
      
      // Allow update if user is authenticated (teacher updating attendance session)
      // schoolCode cannot be changed
      allow update: if isAuthenticated() && 
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['schoolCode']));
      
      // Allow delete if user is authenticated (teacher)
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // ANNOUNCEMENTS COLLECTION (if exists)
    // ============================================
    match /announcements/{announcementId} {
      // Allow read if user is authenticated
      allow read: if isAuthenticated();
      
      // Allow create if user is authenticated (teacher creating announcement)
      allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['schoolCode']);
      
      // Allow update if user is authenticated (teacher)
      allow update: if isAuthenticated();
      
      // Allow delete if user is authenticated (teacher)
      allow delete: if isAuthenticated();
    }
  }
}
